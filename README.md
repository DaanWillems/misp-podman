# misp-podman
This repository contains a templated containerized deployment for MISP that can be deployed with Ansible.
The point is to easily provision various MISP servers that have different configurations and can talk to each other in various topologies. The MISP servers should be production ready and also easily destructable when they are no longer needed. 

This implementation omits a couple of important aspects of the deployment:
- Secrets: The database, admin accounts etc should be securely provisioned instea of plain texxt. This depends on your secret manager.
- Certs: Depending on the method you use to obtain SSL certificates this can be fully automasted or not at all

The following issues are known:
- The MISP docker container overwrites the taxonomies on startup preventing custom taxonomies from existing. This must be fixed in the vendors repository.
- It does not appear possible to provide custom push and pull rules when defining sync servers

Please note that not all features described below are implemented. Check the TODO list at the bottom of this page.

## Overview
By default this setup install two MISP servers hosted on `http://misp-a.daan.nl` and `http://misp-b.daan.nl`. </br>
It also install a reverse proxy to expose these two instances to the internet. 

### Server config
The servers are configured in roles/misp/vars/main.yml.

An example config looks like this:

    misp_servers:
      - name: a
        port: 12345
        hostname: misp-a.daan.nl
      - name: b
        port: 12346
        hostname: misp-b.daan.nl

Name, port and hostname are the only required variables for now.

### SSL Config
To setup SSL on the servers change the roles/misp/templates/misp-proxy/misp.conf.j2 file to include certificates. 
Certs should be placed into a persistent volume (todo: include in playbook)

### MISP Custom Configuration
Custom files for MISP like configs, images, taxonomies, etc should be placed in roles/misp/files/misp-<name>/... Any files not provided are generated by MISP on first startup. 
Running the playbook will overwrite MISP generated files if new config files are added later.

Persistent configuration is split into:
- /media/misp/misp-\<name\>/config/-- All MISP config files  
- /media/misp/misp-\<name\>/files/taxonomies -- For custom taxonomies
- /media/misp/misp-\<name\>/files/img -- For custom images
- /media/misp/misp-\<name\>/files/certs -- For custom certs

Be aware that the container will override the base\_url in config.php with whatever you have entered in vars/main.yml

### MISP Logging
The provided MISP containers do not log all logs to stdout, and instead write to files. These are mounted to /media/misp/misp-\<name\>/logs and should be read by some type of log parser

### Server syncs (W.I.P)
To setup server syncs add them to config in roles/misp/vars/main.yml to the config (view the example config).
In a production environment the auth keys for MISP servers should be managed by some type of vault solution like Ansible Vault or Hashicorp Vault.

### MISP Monitoring
MISP provides no metric endpoints. Therefore we can monitore by HTTP polling, log parsing and black box testing, but whitebox testing is harder. 

# Installation
Make sure you have Ansible and Podman installed (Podman should be sufficiently up to date to support quadlets)

Then install the MISP application by running the Ansible playbook:

`ansible-playbook -i production misp.yml`

For the provided example start both misp servers with: 

`systemctl start misp-a`
`systemctl start misp-b`

To expose the MISP servers start the reverse proxy:

`systemctl start misp-proxy`

# TODO
- [x] Split MISP Docker compose file into quadlets
- [x] Add NGINX reverse proxy docker container to deployment
- [x] Tie services together in systemd app
- [x] Setup deployment with ansible instead of install script
- [x] Template all variables in the deployment with ansible to deploy multiple instances  
- [x] Deploy misp configuration files with ansible
- [x] Deploy misp taxonomies with ansible 
- [ ] Create PR for official MISP Docker repo to fix taxonomy overwrite issue
- [ ] Deploy misp image files
- [ ] Provision MISP server syncs with ansible
- [ ] Provision mounted volume for misp-proxy certs

