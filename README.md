# misp-podman
This repository contains a templated containerized deployment for MISP that can be deployed with Ansible

## Overview
By default this setup install two MISP servers hosted on `http://misp-a.daan.nl` and `http://misp-b.daan.nl`. </br>
It also install a reverse proxy to expose these two instances to the internet. 

### Server config
The servers are configured in misp-deployment/roles/misp/vars/main.yml.

### SSL Config
To setup SSL on the servers change the misp/templates/misp-proxy/misp.conf.j2 file to include a cert. 
Certs should be placed into a persistent volume (todo: include in playbook)

### MISP Config
Prepared files for misp like configs and taxonomies should be placed in roles/misp/files/misp-<name>/. Any files not provided are generated by MISP on first startup. 
Running the playbook will overwrite MISP generated file if new config files are added later.

Files is split into:
- misp-<name>/config/ -- All MISP config files  
- misp-<name>/files/  -- For things like custom taxonomies

### Server syncs
To setup server syncs add them to config in roles/misp/vars/main.yml to the config (view the example config).
In a production environment the auth keys for MISP servers should be managed by some type of vault solution like Ansible Vault or Hashicorp Vault.

### MISP Logging
The provided MISP containers do not log all logs to stdout, and instead write to files. These are mounted to /media/misp/misp-<name>/logs and should be read by some type of log parser

### MISP Monitoring
MISP provides no Prometheus endpoints. Therefore we can monitore by HTTP polling, log parsing and black box testing. 

# Installation

Make sure you have Ansible and Podman installed (Podman should be sufficiently up to date to support quadlets)

Then install the MISP application by running the Ansible playbook:

`ansible-playbook -i production misp.yml`

For the provided example start both misp servers with: 

`systemctl start misp-a`
`systemctl start misp-b`

To expose the MISP servers start the reverse proxy:

`systemctl start misp-proxy`

# TODO
- [x] Split MISP Docker compose file into quadlets
- [x] Add NGINX reverse proxy docker container to deployment
- [x] Tie services together in systemd app
- [ ] Add example NGINX SSL termination single host
- [ ] Setup deployment with ansible instead of install script
- [ ] Template all variables in the deployment with ansible to deploy multiple instances  
- [ ] Add example NGINX SSL termination multiple hosts
